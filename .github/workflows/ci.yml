name: ci

on:
  push:
  pull_request:

permissions:
  contents: read
  pull-requests: write

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        cc: [gcc, clang]
    steps:
      - uses: actions/checkout@v4

      - name: Install build tools
        run: sudo apt-get update && sudo apt-get install -y build-essential clang

      - name: Build
        run: make clean && make CC=${{ matrix.cc }}

      - name: Run tests
        run: make test

  coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install build tools + gcovr
        run: sudo apt-get update && sudo apt-get install -y build-essential gcovr

      - name: Build with coverage flags
        run: |
          make clean
          make CC=gcc CFLAGS="-std=c99 -Wall -Wextra -O0 -g -fno-omit-frame-pointer -D_POSIX_C_SOURCE=200809L --coverage"

      - name: Run tests (coverage)
        run: make test

      - name: Generate coverage reports (gcovr)
        run: |
          rm -rf coverage
          mkdir -p coverage

          # Text report for logs/PR comments
          gcovr --config .gcovr.cfg --txt --output coverage/coverage.txt

          # Cobertura XML
          gcovr --config .gcovr.cfg --xml-pretty --output coverage/coverage.xml

          # HTML report for browsing
          gcovr --config .gcovr.cfg --html --html-details --output coverage/index.html

      - name: Extract coverage snippet
        id: coverage_snippet
        run: |
          echo "text<<'EOF'" >> "$GITHUB_OUTPUT"
          tail -n 50 coverage/coverage.txt >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Publish coverage summary
        run: |
          {
            echo "## Coverage (gcovr)"
            echo
            echo "\`\`\`"
            tail -n 50 coverage/coverage.txt
            echo "\`\`\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage/

      - name: Comment coverage on PR
        if: ${{ github.event_name == 'pull_request' }}
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: coverage
          message: |
            ## Coverage (gcovr)

            ```
            ${{ steps.coverage_snippet.outputs.text }}
            ```

  sanitizers:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install clang
        run: sudo apt-get update && sudo apt-get install -y clang make

      - name: Build with ASan/UBSan
        run: |
          make clean
          make CC=clang CFLAGS="-std=c99 -Wall -Wextra -O1 -g -fno-omit-frame-pointer -D_POSIX_C_SOURCE=200809L -fsanitize=address,undefined"

      - name: Run tests (sanitized)
        env:
          ASAN_OPTIONS: detect_leaks=1:halt_on_error=1
          UBSAN_OPTIONS: halt_on_error=1
        run: make test
